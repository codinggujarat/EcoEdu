{% extends "base.html" %}

{% block title %}Challenges | EcoEdu{% endblock %}

{% block content %}
<div class="min-h-screen py-12 px-6">
    <div class="max-w-7xl mx-auto">
        <!-- Page Layout -->
        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Sidebar Filters -->
            <aside class="w-full lg:w-64 flex-shrink-0 space-y-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-100 mb-2">Challenges</h1>
                    <p class="text-gray-400 text-sm">Earn points & badges.</p>
                </div>

                <!-- Search -->
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm"></i>
                    <input type="text" id="searchInput" placeholder="Search challenges..."
                        class="w-full bg-[#171A1F] border border-[#2A2E35] rounded-lg pl-9 pr-4 py-2.5 text-sm text-gray-200 placeholder-gray-600 focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none transition-colors">
                </div>

                <!-- Filter: Status -->
                <div class="bg-[#171A1F] border border-[#2A2E35] rounded-xl p-5">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">Status</h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" name="status" value="all" checked
                                class="w-4 h-4 rounded border-[#2A2E35] bg-[#0E0F12] text-emerald-500 focus:ring-0 focus:ring-offset-0 transition-colors">
                            <span class="text-sm text-gray-300 group-hover:text-white transition-colors">All
                                Challenges</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" name="status" value="incomplete"
                                class="w-4 h-4 rounded border-[#2A2E35] bg-[#0E0F12] text-emerald-500 focus:ring-0 focus:ring-offset-0 transition-colors">
                            <span class="text-sm text-gray-300 group-hover:text-white transition-colors">To Do</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" name="status" value="completed"
                                class="w-4 h-4 rounded border-[#2A2E35] bg-[#0E0F12] text-emerald-500 focus:ring-0 focus:ring-offset-0 transition-colors">
                            <span
                                class="text-sm text-gray-300 group-hover:text-white transition-colors">Completed</span>
                        </label>
                    </div>
                </div>

                <!-- Filter: Difficulty -->
                <div class="bg-[#171A1F] border border-[#2A2E35] rounded-xl p-5">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">Difficulty</h3>
                    <div class="space-y-3">
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" name="difficulty" value="easy"
                                class="w-4 h-4 rounded border-[#2A2E35] bg-[#0E0F12] text-emerald-500 focus:ring-0 focus:ring-offset-0 transition-colors">
                            <span class="text-sm text-gray-300 group-hover:text-white transition-colors">Easy</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" name="difficulty" value="medium"
                                class="w-4 h-4 rounded border-[#2A2E35] bg-[#0E0F12] text-emerald-500 focus:ring-0 focus:ring-offset-0 transition-colors">
                            <span class="text-sm text-gray-300 group-hover:text-white transition-colors">Medium</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer group">
                            <input type="checkbox" name="difficulty" value="hard"
                                class="w-4 h-4 rounded border-[#2A2E35] bg-[#0E0F12] text-emerald-500 focus:ring-0 focus:ring-offset-0 transition-colors">
                            <span class="text-sm text-gray-300 group-hover:text-white transition-colors">Hard</span>
                        </label>
                    </div>
                </div>
            </aside>

            <!-- Challenges Grid -->
            <div class="flex-1">
                {% if challenges %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="challengesGrid">
                    {% for challenge in challenges %}
                    {% set is_completed = challenge.id in completed_ids %}

                    <div class="challenge-card group bg-[#171A1F] border border-[#2A2E35] rounded-xl p-6 hover:border-emerald-500/30 transition-all duration-300 flex flex-col h-full relative overflow-hidden"
                        data-difficulty="{{ challenge.difficulty|lower }}"
                        data-status="{{ 'completed' if is_completed else 'incomplete' }}"
                        data-title="{{ challenge.title|lower }}">

                        <!-- Status Badge -->
                        {% if is_completed %}
                        <div
                            class="absolute top-4 right-4 bg-emerald-500/10 text-emerald-500 text-xs font-bold px-3 py-1 rounded-full border border-emerald-500/20 flex items-center gap-1">
                            <i class="fas fa-check"></i> Completed
                        </div>
                        {% endif %}

                        <div class="flex items-start justify-between mb-4">
                            <div
                                class="w-12 h-12 bg-[#0E0F12] border border-[#2A2E35] rounded-lg flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">
                                {{ challenge.badge_icon or 'ðŸ“œ' }}
                            </div>
                        </div>

                        <h3 class="text-lg font-bold text-gray-100 mb-2 group-hover:text-emerald-500 transition-colors">
                            {{ challenge.title }}</h3>
                        <p class="text-sm text-gray-400 mb-6 line-clamp-2 flex-grow">{{ challenge.description }}</p>

                        <div class="flex items-center gap-3 mb-6">
                            <div
                                class="flex items-center gap-1.5 text-xs font-medium text-gray-400 bg-[#0E0F12] px-2.5 py-1 rounded-md border border-[#2A2E35]">
                                <i class="fas fa-bolt text-emerald-500"></i>
                                {{ challenge.points }} pts
                            </div>
                            <div
                                class="flex items-center gap-1.5 text-xs font-medium text-gray-400 bg-[#0E0F12] px-2.5 py-1 rounded-md border border-[#2A2E35]">
                                <i class="fas fa-layer-group text-blue-500"></i>
                                {{ challenge.difficulty|title }}
                            </div>
                        </div>

                        <div class="mt-auto">
                            {% if is_completed %}
                            <button disabled
                                class="w-full py-2.5 bg-[#0E0F12] border border-[#2A2E35] text-gray-500 text-sm font-medium rounded-lg cursor-not-allowed opacity-70">
                                Already Completed
                            </button>
                            {% else %}
                            <a href="{{ url_for('complete_challenge', challenge_id=challenge.id) }}"
                                class="flex items-center justify-center w-full py-2.5 bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium rounded-lg shadow-lg shadow-emerald-900/20 transition-all group-hover:translate-y-[-2px]">
                                Start Challenge
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <!-- No Results State -->
                <div id="noResults" class="hidden text-center py-20 bg-[#171A1F] border border-[#2A2E35] rounded-xl">
                    <div
                        class="w-16 h-16 bg-[#0E0F12] rounded-full flex items-center justify-center mx-auto mb-4 text-gray-600">
                        <i class="fas fa-search text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-200 mb-2">No matches found</h3>
                    <p class="text-gray-500 text-sm">Try adjusting your filters or search terms.</p>
                </div>

                {% else %}
                <!-- Empty State (No challenges in DB) -->
                <div class="text-center py-20 bg-[#171A1F] border border-[#2A2E35] rounded-xl">
                    <div
                        class="w-16 h-16 bg-[#0E0F12] rounded-full flex items-center justify-center mx-auto mb-4 text-gray-600">
                        <i class="fas fa-clipboard-list text-2xl"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-200 mb-2">No Challenges Available</h3>
                    <p class="text-gray-500 max-w-sm mx-auto">There are currently no active challenges. Check back later
                        for new missions!</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const searchInput = document.getElementById('searchInput');
        const statusCheckboxes = document.querySelectorAll('input[name="status"]');
        const difficultyCheckboxes = document.querySelectorAll('input[name="difficulty"]');
        const cards = document.querySelectorAll('.challenge-card');
        const grid = document.getElementById('challengesGrid');
        const noResults = document.getElementById('noResults');

        function filterChallenges() {
            const searchTerm = searchInput.value.toLowerCase();

            // Get selected statuses
            const statusChecked = Array.from(statusCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            // Handle "All" logic
            const showAllStatus = statusChecked.includes('all') || statusChecked.length === 0;

            // Get selected difficulties
            const difficultyChecked = Array.from(difficultyCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            let visibleCount = 0;

            cards.forEach(card => {
                const title = card.getAttribute('data-title');
                const status = card.getAttribute('data-status');
                const difficulty = card.getAttribute('data-difficulty');

                const matchesSearch = title.includes(searchTerm);

                const matchesStatus = showAllStatus || statusChecked.includes(status);
                // If "all" is checked, we ignore checking specific statuses, unless user unchecks 'all' and checks specifics. 
                // Better UX: If "All" is checked, uncheck others. Implemented below in change event.

                const matchesDifficulty = difficultyChecked.length === 0 || difficultyChecked.includes(difficulty);

                if (matchesSearch && matchesStatus && matchesDifficulty) {
                    card.classList.remove('hidden');
                    visibleCount++;
                } else {
                    card.classList.add('hidden');
                }
            });

            if (visibleCount === 0 && cards.length > 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
            }
        }

        // Event Listeners
        searchInput.addEventListener('input', filterChallenges);

        statusCheckboxes.forEach(cb => {
            cb.addEventListener('change', (e) => {
                // Exclusive "All" behavior logic
                if (e.target.value === 'all' && e.target.checked) {
                    statusCheckboxes.forEach(c => { if (c.value !== 'all') c.checked = false; });
                } else if (e.target.value !== 'all' && e.target.checked) {
                    document.querySelector('input[name="status"][value="all"]').checked = false;
                }
                // If nothing checked, check "All"
                const anyChecked = Array.from(statusCheckboxes).some(c => c.checked);
                if (!anyChecked) {
                    document.querySelector('input[name="status"][value="all"]').checked = true;
                }
                filterChallenges();
            });
        });

        difficultyCheckboxes.forEach(cb => {
            cb.addEventListener('change', filterChallenges);
        });
    });
</script>
{% endblock %}